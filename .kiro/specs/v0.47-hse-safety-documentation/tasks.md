# Implementation Plan: v0.47 HSE - Safety Documentation

## Overview

This implementation plan covers the HSE Safety Documentation system for managing JSAs, SOPs, safety permits, and MSDS with version control, expiry tracking, and approval workflows. The implementation follows an incremental approach, building from database schema through utility functions, server actions, and finally UI components.

## Tasks

- [x] 1. Database Schema Setup
  - [x] 1.1 Create safety_document_categories table with defaults
    - Create table with category_code, category_name, requires_expiry, default_validity_days, requires_approval
    - Insert 9 default categories (jsa, sop, permit, msds, risk_assessment, toolbox_talk, inspection, emergency, training_material)
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - [x] 1.2 Create safety_documents table
    - Create table with document_number, category_id, title, version control fields, content/file fields, validity fields, approval fields
    - Add foreign keys to safety_document_categories, employees, user_profiles
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 5.1_
  - [x] 1.3 Create safety_document_acknowledgments table
    - Create table with document_id, employee_id, acknowledged_at, quiz_score, quiz_passed
    - Add unique constraint on (document_id, employee_id)
    - _Requirements: 6.1, 6.2, 6.3, 6.4_
  - [x] 1.4 Create jsa_hazards table
    - Create table with document_id, step_number, work_step, hazards, consequences, risk_level, control_measures, responsible
    - Add foreign key to safety_documents with CASCADE delete
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [x] 1.5 Create safety_permits table
    - Create table with permit_number, permit_type, work details, validity, multi-level approvals, closure fields
    - Add foreign keys to safety_documents, job_orders, employees
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8_
  - [x] 1.6 Create document number sequence and trigger
    - Create sequence safety_doc_seq
    - Create generate_safety_doc_number() function
    - Create trigger to auto-generate CATEGORY-YYYY-NNNN format
    - _Requirements: 2.1_
  - [x] 1.7 Create indexes for performance
    - Index on safety_documents(category_id, status, expiry_date)
    - Index on safety_permits(valid_from, valid_to, status)
    - Index on jsa_hazards(document_id)
    - _Requirements: 9.5, 9.6_
  - [x] 1.8 Create expiring_safety_documents view
    - Create view with validity_status and days_until_expiry calculations
    - Join with categories and employees
    - _Requirements: 5.2, 5.3, 5.4_
  - [x] 1.9 Enable RLS policies
    - Enable RLS on all safety document tables
    - Create policies for read/write based on role
    - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [x] 2. TypeScript Types and Interfaces
  - [x] 2.1 Create types/safety-document.ts with all interfaces
    - Define DocumentStatus, PermitStatus, PermitType, RiskLevel types
    - Define DocumentCategory, SafetyDocument, JSAHazard, DocumentAcknowledgment interfaces
    - Define SafetyPermit interface
    - Define input types: CreateDocumentInput, CreatePermitInput, JSAHazardInput
    - Define DocumentStatistics, PermitStatistics, filter interfaces
    - Define row types and transform functions
    - _Requirements: 2.2, 2.3, 4.1, 7.3, 8.1, 8.4, 9.1_

- [x] 3. Core Utility Functions
  - [x] 3.1 Create lib/safety-document-utils.ts with helper functions
    - Implement validateDocumentInput, validatePermitInput, validateJSAHazardInput
    - Implement calculateExpiryDate, getValidityStatus, getDaysUntilExpiry, isExpiringSoon
    - Implement getDocumentStatusColor, getDocumentStatusLabel
    - Implement getPermitStatusColor, getPermitStatusLabel
    - Implement getRiskLevelColor, getRiskLevelLabel
    - Implement countByStatus, countByCategory, countExpiringDocuments
    - Implement calculateAcknowledgmentRate
    - Implement getCategoryLabel, getPermitTypeLabel
    - _Requirements: 1.3, 4.1, 5.2, 5.3, 7.3, 8.1, 8.4, 9.1, 9.2, 9.3, 9.4_
  - [x] 3.2 Write property tests for utility functions
    - **Property 1: Category Settings Enforcement** - Test expiry date calculation
    - **Property 6: Expiry Tracking Accuracy** - Test validity status classification
    - **Property 10: Dashboard Statistics Accuracy** - Test count functions
    - Test validation functions
    - Test status/color helper functions
    - _Requirements: 1.3, 5.1, 5.2, 5.3, 9.1, 9.2, 9.3, 9.4_

- [x] 4. Checkpoint - Core Functions Complete
  - All 39 property tests pass

- [x] 5. Server Actions - Documents
  - [x] 5.1 Create lib/safety-document-actions.ts with CRUD operations
    - Implement getDocumentCategories function
    - Implement createSafetyDocument with auto-number generation
    - Implement getSafetyDocument and getSafetyDocuments with filters
    - Implement updateSafetyDocument function
    - _Requirements: 1.1, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 9.5, 9.6_
  - [x] 5.2 Implement version control functions
    - Implement createNewVersion function
    - Mark previous version as superseded
    - Link new version to previous
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  - [x] 5.3 Implement approval workflow functions
    - Implement submitForReview function
    - Implement approveDocument function
    - Implement rejectDocument function
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_
  - [x] 5.4 Implement acknowledgment functions
    - Implement acknowledgeDocument function
    - Implement getDocumentAcknowledgments function
    - Implement getAcknowledgmentStats function
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  - [x] 5.5 Implement JSA hazard functions
    - Implement addJSAHazard function
    - Implement updateJSAHazard function
    - Implement deleteJSAHazard function
    - Implement getJSAHazards function
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [x] 5.6 Implement statistics functions
    - Implement getDocumentStatistics function
    - Implement getExpiringDocuments function
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 5.4_
  - [x] 5.7 Write unit tests for document actions
    - Test createSafetyDocument creates document with correct defaults
    - Test version control creates new version and supersedes old
    - Test approval workflow transitions
    - Test acknowledgment prevents duplicates
    - Test JSA hazard CRUD operations
    - Test statistics calculations
    - _Requirements: 2.1, 3.1, 4.1, 6.4, 7.1, 9.1_

- [x] 6. Server Actions - Permits
  - [x] 6.1 Create lib/safety-permit-actions.ts with CRUD operations
    - Implement createSafetyPermit function
    - Implement getSafetyPermit and getSafetyPermits with filters
    - _Requirements: 8.1, 8.2, 8.5, 8.6_
  - [x] 6.2 Implement permit approval functions
    - Implement approveBySupervisor function
    - Implement approveByHSE function
    - Implement activatePermit function
    - _Requirements: 8.3, 8.4_
  - [x] 6.3 Implement permit closure functions
    - Implement closePermit function
    - Implement cancelPermit function
    - Implement auto-expire logic
    - _Requirements: 8.7, 8.8_
  - [x] 6.4 Implement permit statistics function
    - Implement getPermitStatistics function
    - _Requirements: 9.1_
  - [x] 6.5 Write unit tests for permit actions
    - Test createSafetyPermit validates required fields
    - Test multi-level approval workflow
    - Test permit closure records metadata
    - Test permit expiry logic
    - _Requirements: 8.2, 8.3, 8.7, 8.8_

- [x] 7. Checkpoint - Server Actions Complete
  - 17 unit tests pass for document actions
  - 39 property tests pass

- [x] 8. Document Components
  - [x] 8.1 Create components/safety-documents/document-summary-cards.tsx
    - Display total documents, approved, pending review, expiring within 30 days
    - Use Card components with appropriate icons and colors
    - _Requirements: 9.1, 9.2, 9.3, 9.4_
  - [x] 8.2 Create components/safety-documents/document-status-badge.tsx
    - Color-coded badge for document status
    - _Requirements: 4.1_
  - [x] 8.3 Create components/safety-documents/validity-badge.tsx
    - Color-coded badge for validity status (valid, expiring_soon, expired)
    - _Requirements: 5.2_
  - [x] 8.4 Create components/safety-documents/document-card.tsx
    - Display document number, title, category, expiry date, status
    - Link to document detail page
    - _Requirements: 9.5_
  - [x] 8.5 Create components/safety-documents/document-list.tsx
    - List documents with filters (category, status, search)
    - Use document-card for each item
    - Support pagination
    - _Requirements: 9.5, 9.6_
  - [x] 8.6 Create components/safety-documents/category-select.tsx
    - Dropdown for document categories
    - _Requirements: 1.1_
  - [x] 8.7 Create components/safety-documents/document-form.tsx
    - Form for creating/editing documents (implemented in new-document-client.tsx)
    - Support file upload
    - Auto-calculate expiry from category defaults
    - _Requirements: 2.2, 2.3, 2.4, 2.5, 1.3_
  - [x] 8.8 Create components/safety-documents/index.ts barrel export
    - Export all document components
    - _Requirements: 9.1_

- [x] 9. JSA Components
  - [x] 9.1 Create components/safety-documents/jsa-hazard-form.tsx
    - Form for adding/editing JSA hazard steps
    - Risk level selector
    - _Requirements: 7.2, 7.3, 7.4_
  - [x] 9.2 Create components/safety-documents/jsa-hazard-table.tsx
    - Table displaying hazard steps with risk level badges
    - Edit and delete actions
    - _Requirements: 7.1, 7.3_
  - [x] 9.3 Create components/safety-documents/risk-level-badge.tsx
    - Color-coded badge for risk levels
    - _Requirements: 7.3_

- [x] 10. Acknowledgment Components
  - [x] 10.1 Create components/safety-documents/acknowledgment-button.tsx
    - Button to acknowledge document
    - Show acknowledged status if already done
    - _Requirements: 6.1_
  - [x] 10.2 Create components/safety-documents/acknowledgment-list.tsx
    - List of employees who acknowledged document
    - Show quiz scores if applicable
    - _Requirements: 6.2, 6.3, 6.5_
  - [x] 10.3 Create components/safety-documents/acknowledgment-stats.tsx
    - Display acknowledgment completion rate
    - _Requirements: 6.5_

- [x] 11. Permit Components
  - [x] 11.1 Create components/safety-permits/permit-summary-cards.tsx
    - Display total permits, active, pending approval, completed this month
    - _Requirements: 9.1_
  - [x] 11.2 Create components/safety-permits/permit-status-badge.tsx
    - Color-coded badge for permit status
    - _Requirements: 8.4_
  - [x] 11.3 Create components/safety-permits/permit-type-badge.tsx
    - Badge showing permit type
    - _Requirements: 8.1_
  - [x] 11.4 Create components/safety-permits/permit-card.tsx
    - Display permit number, type, location, validity, status
    - Link to permit detail page
    - _Requirements: 8.1, 8.2_
  - [x] 11.5 Create components/safety-permits/permit-list.tsx
    - List permits with filters (type, status, search)
    - Use permit-card for each item
    - _Requirements: 8.1, 8.4_
  - [x] 11.6 Create components/safety-permits/permit-form.tsx
    - Form for creating permits (implemented in new-permit-client.tsx)
    - Permit type selector, date range picker
    - PPE checklist, precautions textarea
    - _Requirements: 8.2, 8.6_
  - [x] 11.7 Create components/safety-permits/permit-approval-panel.tsx
    - Show approval status for supervisor and HSE
    - Approve/reject buttons based on role
    - _Requirements: 8.3_
  - [x] 11.8 Create components/safety-permits/permit-closure-dialog.tsx
    - Dialog to close permit with notes
    - _Requirements: 8.7_
  - [x] 11.9 Create components/safety-permits/index.ts barrel export
    - Export all permit components
    - _Requirements: 8.1_

- [x] 12. Document Pages
  - [x] 12.1 Create app/(main)/hse/documents/page.tsx and documents-client.tsx
    - Server component to fetch statistics and documents
    - Client component with summary cards, filters, document list
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_
  - [x] 12.2 Create app/(main)/hse/documents/new/page.tsx and new-document-client.tsx
    - Server component to fetch categories
    - Client component with document form
    - Handle form submission and redirect
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [x] 12.3 Create app/(main)/hse/documents/[id]/page.tsx and document-detail-client.tsx
    - Server component to fetch document with hazards and acknowledgments
    - Client component with document details, approval actions, JSA table, acknowledgment list
    - _Requirements: 3.1, 4.1, 4.2, 4.3, 6.1, 7.1_

- [x] 13. Permit Pages
  - [x] 13.1 Create app/(main)/hse/permits/page.tsx and permits-client.tsx
    - Server component to fetch statistics and permits
    - Client component with summary cards, filters, permit list
    - _Requirements: 8.1, 8.4, 9.1_
  - [x] 13.2 Create app/(main)/hse/permits/new/page.tsx and new-permit-client.tsx
    - Server component to fetch job orders
    - Client component with permit form
    - Handle form submission and redirect
    - _Requirements: 8.2, 8.5, 8.6_
  - [x] 13.3 Create app/(main)/hse/permits/[id]/page.tsx and permit-detail-client.tsx
    - Server component to fetch permit with approvals
    - Client component with permit details, approval panel, closure dialog
    - _Requirements: 8.3, 8.4, 8.7_

- [x] 14. Navigation Integration
  - [x] 14.1 Add Documents and Permits to HSE submenu
    - Add /hse/documents route
    - Add /hse/permits route
    - _Requirements: 9.1_

- [x] 15. Notification Integration
  - [x] 15.1 Add document notification triggers
    - Notify reviewers on document submission
    - Notify preparer on document approval
    - Notify HSE team on expiring documents
    - Notify approvers on permit request
    - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [x] 16. Final Checkpoint
  - [x] All tests pass (56 tests: 17 unit + 39 property)
  - [x] Database schema verified via MCP
  - [x] UI components created and exported
  - [x] Navigation integrated
  - [x] Notifications working

## Notes

- All tasks including tests are required for comprehensive coverage
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- Indonesian labels used where appropriate per steering guidelines

